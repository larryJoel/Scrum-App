define(['hammer','jquery','fc/utils'],function(hammer,$,fc_utils){function start_slider(slider,options){var lis=slider.find('ul li');var movements=lis.length;var first_li=lis.eq(1);var first_li_width=first_li.width()+parseInt(first_li.css('padding-left'));var element_per_movements=options.element_per_movements||Math.floor(slider.width()/first_li_width);if(element_per_movements<1){element_per_movements=1;}
var max_index=Math.ceil(movements/element_per_movements);var initial_offset;var move_value;if(element_per_movements==1){initial_offset=(slider.width()-first_li.width())/2-parseInt(first_li.css('padding-left'));if(initial_offset<0){initial_offset=0;}
move_value=first_li_width;}else{initial_offset=first_li.width()/4;move_value=first_li_width*element_per_movements;}
if(options.initial_offset!==false){initial_offset=options.initial_offset;}
slider.data('index',0);slider.data('hide_offset',options.hide_offset);slider.data('max_index',max_index);slider.data('max_scroll',slider.find('ul').width()-slider.find('.slider-scrollable').width());slider.data('move_value',move_value);slider.data('initial_offset',initial_offset);if(max_index>1){var slider_html='<span class="active" data-index="0"><span></span></span>';for(var i=0;i<max_index-1;i++){slider_html+='<span data-index="'+(i+1)+'"><span></span></span>';}
slider.find('.slider-progress').append(slider_html);var slider_shadow_right='<span class="next-shadow"></span>';var slider_shadow_left='<span class="previous-shadow"></span>';slider.find('.slider-content').append(slider_shadow_left);slider.find('.slider-content').append(slider_shadow_right);slider.addClass('slider-continue-right');}
if(options.popover!=false){if(!fc_utils.responsive.isMobile()){require(['jquery-bootstrap'],function(bootstrap){var popover_options=options.popover;popover_options['html']=true;popover_options['template']='<div class="highlighted-sources-popover popover" role="tooltip">'+'<div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content">'+'</div></div>';popover_options['content']=function(){var content='<a href="'+$(this).attr('href')+'"><img src="'+$(this).find('img').attr('src')+'"></a>';return content;};popover_options['title']=function(){var content='<a href="'+$(this).attr('href')+'"><img src="'+$(this).find('img').attr('src')+'"></a>';return content;};lis.find('a').popover(popover_options);});}}}
function animate_to_index(slider,new_index){slider.find('.slider-scrollable').stop(true,false);var new_value=slider.data('move_value')*new_index-slider.data('initial_offset');if(new_index==0&&slider.data('hide_offset')){new_value=0;}
new_value=Math.min(slider.data('max_scroll'),new_value);slider.find('.slider-scrollable').animate({'scrollLeft':new_value},400,function(){slider_progress(slider,slider.find('.slider-scrollable').scrollLeft());});}
function animation(slider,e){e.preventDefault();if($(e.target).parent().hasClass('next')){_gaq.push(['_trackEvent',$(e.target).parent().data('ga-event'),'Next','']);new_index=slider.data('index')+1;}else{_gaq.push(['_trackEvent',$(e.target).parent().data('ga-event'),'Previous','']);new_index=slider.data('index')-1;}
animate_to_index(slider,new_index);}
function scroll_spy(slider){slider.find('.slider-scrollable').one('scroll',function(e){setInterval(function(){slider_progress(slider,$(e.currentTarget).scrollLeft());},300);});}
function slider_progress(slider,new_scroll){var new_index=0;if(new_scroll>=slider.data('max_scroll')){new_index=slider.data('max_index')-1;}
else if(new_scroll>0){new_index=Math.ceil((new_scroll+slider.data('initial_offset')+1)/slider.data('move_value'))-1;}
slider.find('.slider-progress > span').eq(slider.data('index')).removeClass('active');slider.data('index',new_index);slider.find('.slider-progress > span').eq(new_index).addClass('active');if(new_scroll<=0){slider.removeClass('slider-continue-left');}
else if(new_scroll>=slider.data('max_scroll')){slider.removeClass('slider-continue-right');}
else{slider.addClass('slider-continue-right');slider.addClass('slider-continue-left');}}
function init(slider,options){options=options||{}
options=$.extend({initial_offset:false,hidden_offset:false,element_per_movements:false,popover:false,},options);start_slider(slider,options);slider.on('click','.next,.previous',function(e){animation(slider,e);});scroll_spy(slider);slider.on('click','.slider-progress > span',function(e){_gaq.push(['_trackEvent',$(e.currentTarget).parent().data('ga-event'),'Change','']);e.preventDefault();animate_to_index(slider,$(e.currentTarget).data('index'));});if(!options.hide_offset){slider.find('ul').eq(0).css('margin-left',slider.data('initial_offset')+'px');}}
return{'init':init};});
define(['hammer','jquery','fc/utils'],function(hammer,$,fc_utils){var index=0;var max_index=0;var move_value=0;var initial_offset=0;var hide_offset=false;function _compute(slider,options){var lis=slider.find('ul li');var movements=lis.length;var first_li=lis.eq(1);var first_li_padding_left=parseInt(first_li.css('padding-left'));var first_li_width=first_li.width()+first_li_padding_left;var _element_per_movements=function(){return Math.floor((slider_width-initial_offset)/first_li_width)||1;};var _max_index=function(){return Math.ceil(movements/element_per_movements);};var slider_width=slider.width();if(parseInt(lis.eq(0).css('padding-left'))==0){slider_width+=first_li_padding_left}
initial_offset=0;var element_per_movements=options.element_per_movements||_element_per_movements();if(element_per_movements<1){element_per_movements=1;}
initial_offset=options.initial_offset||0;if(initial_offset<0){initial_offset=0;}
hide_offset=options.hide_offset;max_index=_max_index();if(max_index>1){if(options.initial_offset===false){var centered_offset=(slider.width()-first_li.width())/2-first_li_padding_left;if(centered_offset<0){centered_offset=0;}
var quarter_offset=Math.round(first_li.width()/4);}
if(options.element_per_movements===false){if(options.initial_offset===false){if(element_per_movements==1){initial_offset=centered_offset;}
else{initial_offset=quarter_offset;element_per_movements=_element_per_movements();if(element_per_movements==1){initial_offset=centered_offset;}}}
else{element_per_movements=_element_per_movements();if(element_per_movements==1){initial_offset=centered_offset;}}}
else{if(options.initial_offset===false){initial_offset=quarter_offset;}}
if(element_per_movements==1){move_value=first_li_width;}
else{move_value=first_li_width*element_per_movements;}
max_index=Math.ceil(movements/element_per_movements);var slider_html='';for(var i=0;i<max_index;i++){slider_html+='<span '+(i==index?'class="active" ':'')+'data-index="'+i+'"><span></span></span>';}
slider.find('.slider-progress').html(slider_html);if(slider.find('.slider-content .previous-shadow').length==0){var slider_shadow_left='<span class="previous-shadow"></span>';var slider_shadow_right='<span class="next-shadow"></span>';slider.find('.slider-content').append(slider_shadow_left);slider.find('.slider-content').append(slider_shadow_right);}
_trigger_shadows(slider,index);if(index>max_index-1){index=max_index-1;}}
else{slider.find('.slider-progress').empty();slider.find('.slider-content .previous-shadow').remove();slider.find('.slider-content .next-shadow').remove();slider.removeClass('slider-continue-right');slider.find('ul').eq(0).css('margin-left',0);}}
function start_slider(slider,options){_compute(slider,options);if(!options.hide_offset){slider.find('ul').eq(0).css('margin-left',initial_offset+'px');}
$(document).on('window_resize',$('body'),function(e,data){data=data||{};if(data.width){_compute(slider,options);animate_to_index(slider,index);}});if(options.popover!=false){if(!fc_utils.responsive.isMobile()){require(['jquery-bootstrap'],function(bootstrap){var popover_options=options.popover;popover_options['html']=true;popover_options['template']='<div class="highlighted-sources-popover popover" role="tooltip">'+'<div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content">'+'</div></div>';popover_options['content']=function(){var content='<a href="'+$(this).attr('href')+'"><img src="'+$(this).find('img').attr('src')+'"></a>';return content;};slider.find('ul li a').popover(popover_options);});}}}
function _trigger_shadows(slider,new_index){if(new_index==0){slider.addClass('slider-continue-right');}
else if(new_index==max_index-1){slider.addClass('slider-continue-left');}
else{slider.addClass('slider-continue-left');slider.addClass('slider-continue-right');}}
function animate_to_index(slider,new_index){var slider_ul=slider.find('ul').eq(0).stop(true,false);if(new_index>max_index-1){new_index=0;}else if(new_index<0){new_index=max_index-1;}
_trigger_shadows(slider,new_index);var new_value=move_value*-new_index+initial_offset;if(new_index==0&&hide_offset){new_value=0;}
slider.find('.slider-progress > span').eq(index).removeClass('active');index=new_index;slider.find('.slider-progress > span').eq(index).addClass('active');slider_ul.animate({'margin-left':new_value+'px'},400,function(){if(new_index==0){slider.removeClass('slider-continue-left');}
else if(new_index==max_index-1){slider.removeClass('slider-continue-right');}});}
function animation(slider,e){e.preventDefault();if($(e.target).parent().hasClass('next')){_gaq.push(['_trackEvent',$(e.target).parent().data('ga-event'),'Next','']);new_index=index+1;}else{_gaq.push(['_trackEvent',$(e.target).parent().data('ga-event'),'Previous','']);new_index=index-1;}
animate_to_index(slider,new_index);}
function init(slider,options){options=options||{}
options=$.extend({initial_offset:false,hidden_offset:false,element_per_movements:false,popover:false,},options);start_slider(slider,options);slider.on('click','.next,.previous',function(e){animation(slider,e);});var hammertime=slider.hammer();hammertime.on("dragleft",function(e){e.preventDefault();});hammertime.on("dragright",function(e){e.preventDefault();});hammertime.on('dragend',function(e){var deltaYignorable=Math.abs(e.gesture.deltaY)<Math.abs(e.gesture.deltaX/3);if(!deltaYignorable){return;}
e.preventDefault();if(e.gesture.deltaX<0){slider.find('.next a').trigger('click');}else if(e.gesture.deltaX>0){slider.find('.previous a').trigger('click');}});slider.on('click','.slider-progress > span',function(e){_gaq.push(['_trackEvent',$(e.currentTarget).parent().data('ga-event'),'Change','']);e.preventDefault();animate_to_index(slider,$(e.currentTarget).data('index'));});}
return{'init':init};});
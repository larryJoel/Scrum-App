define(['jquery','fc/ui/freeze'],function($,fc_ui_freeze){var absolute_url_regexp=/^(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;var event_listener_added=false;var default_opts={loader:false,params:{},url:false,data:false,launch_push_state:true,positionToElement:false,scroll_top:true,url_kind:'fc/ui/change_page',auto_freeze:false,auto_freeze_background_position:'20px',};function make_replace(opts,new_page){var old_wrapper=$(document).find('#wrapper');var new_wrapper=$(new_page).filter('#wrapper');var new_title=$(new_page).filter('title').text();old_wrapper.replaceWith(new_wrapper);document.title=new_title;var url_postfix='';if(opts.positionToElement==false){if(opts.scroll_top==true){window.scrollTo(0,0);}}else{var baseUrl=window.location.href.split('#')[0];var url_postfix='#'+opts.positionToElement;}
$(document).trigger('page_changed');if(opts.launch_push_state){window.history.pushState(opts,"",opts.url+url_postfix);}}
function replace(opts){var opts=opts||{}
opts=$.extend({},default_opts,opts);if(!absolute_url_regexp.test(opts.url)){throw new Error("URL has to be absolute!");}
if(true){if(opts.positionToElement==false){window.location=opts.url;}else{window.location=opts.url+'#'+opts.positionToElement;}
return;}
listen_back(opts);if(opts.data){make_replace(opts,opts.data);}else{if(opts.auto_freeze){fc_ui_freeze.freeze($('#content'),{'position':opts.auto_freeze_background_position});}
$.ajax({url:opts.url,beforeSend:function(jqXHR){jqXHR.setRequestHeader("Show-Full-Body","1");}}).done(function(new_page){var analytics_url=opts.url.replace(window.location.protocol+'//'+window.location.host,'');_gaq.push(['_trackPageview',analytics_url]);if(opts.positionToElement){$('html, body').animate({scrollTop:$("#"+opts.positionToElement).offset().top},0);}
make_replace(opts,new_page);if(opts.positionToElement){$('html, body').animate({scrollTop:$("#"+opts.positionToElement).offset().top},0);}}).complete(function(){if(opts.auto_freeze){fc_ui_freeze.unfreeze($('#content'));}});}}
function listen_back(opts){if(!event_listener_added&&window.history&&window.history.pushState){event_listener_added=true;var start_opts=$.extend({},opts,{url:window.location.href});window.history.pushState(start_opts,"",start_opts.url);$(window).on('popstate',function(evt){var event=evt.originalEvent;if(event.state&&event.state.url_kind=='fc/ui/change_page'){replace($.extend({},event.state,{launch_push_state:false}));}else{replace($.extend({},start_opts,{launch_push_state:false,url:window.location.href}));}});}}
return replace;});